# サブスクリプション契約テストガイド

サブスクリプション機能のテストを行うための詳細なガイドです。

## 概要

このテストシステムは、AI Creative Stockのサブスクリプション機能を包括的にテストするために設計されています。

### テスト対象機能
- サブスクリプション契約の作成・削除
- 決済処理（Stripe）
- ダウンロード制限の適用
- ユーザー状態の管理

## アクセス方法

### 1. 管理者権限の確認
- 管理者ユーザーでログイン
- ヘッダーに「サブスクテスト」ボタンが表示される
- ボタンをクリックしてテストパネルにアクセス

### 2. テストパネルの構成
- **ユーザー情報**: 現在のユーザー詳細
- **サブスクリプション状態**: 現在のサブスクリプション状況
- **テストコントロール**: 各種テスト機能
- **テスト結果**: E2Eテストの実行結果
- **Stripeテストカード**: 決済テスト用のカード情報
- **テストサブスクリプション一覧**: 作成されたテストデータ

## テスト機能詳細

### 1. E2Eテスト
完全なサブスクリプション機能のテストフローを実行します。

#### テストフロー
1. 初期状態確認（サブスクリプション未契約）
2. テストサブスクリプション作成
3. サブスクリプション状態確認
4. テストサブスクリプション削除
5. 最終状態確認（サブスクリプション未契約）

#### 使用方法
```
1. 「E2Eテスト実行」ボタンをクリック
2. テスト結果がリアルタイムで表示される
3. 各ステップの成功/失敗を確認
```

### 2. テストサブスクリプション管理

#### 作成
```
1. プランを選択（スタンダード、プロ、プロプラス）
2. 「テストサブスクリプション作成」ボタンをクリック
3. 30日間のテストサブスクリプションが作成される
```

#### 削除
```
1. 「テストサブスクリプション削除」ボタンをクリック
2. 現在のユーザーのテストサブスクリプションが削除される
```

### 3. Stripeテストカード

#### 利用可能なテストカード
- **成功カード**: `4242424242424242`
- **拒否カード**: `4000000000000002`
- **残高不足カード**: `4000000000009995`
- **3Dセキュア認証カード**: `4000002500003155`

#### 共通情報
- 有効期限: `12/34`
- CVC: `123`
- 郵便番号: 任意

## サブスクリプションプラン

### 1. スタンダードプラン
- 月額: ¥980
- ダウンロード数: 10本/月
- 高画質動画: あり

### 2. プロプラン
- 月額: ¥1,980
- ダウンロード数: 50本/月
- 高画質動画: あり
- 商用利用: 可能

### 3. プロプラスプラン
- 月額: ¥2,980
- ダウンロード数: 無制限
- 高画質動画: あり
- 商用利用: 可能
- 優先サポート: あり

## テスト環境設定

### 1. 環境変数
```env
# Stripe設定
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...

# Supabase設定
VITE_SUPABASE_URL=https://xwwvjoqiicwrjzvzjqju.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 2. データベース設定
```sql
-- サブスクリプションテーブル
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  plan_id VARCHAR NOT NULL,
  status VARCHAR NOT NULL,
  stripe_customer_id VARCHAR,
  stripe_subscription_id VARCHAR,
  current_period_start TIMESTAMP,
  current_period_end TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

## 実行手順

### 1. 基本テスト
```
1. 管理者でログイン
2. サブスクテストページにアクセス
3. 初期状態を確認（サブスクリプション未契約）
4. E2Eテストを実行
5. すべてのステップが成功することを確認
```

### 2. 決済テスト
```
1. 通常のプランページにアクセス
2. プランを選択
3. Stripeテストカードで決済
4. 決済完了後、サブスクリプション状態を確認
5. サブスクテストページでデータを確認
```

### 3. ダウンロード制限テスト
```
1. サブスクリプション契約
2. ダッシュボードで動画をダウンロード
3. 制限に達するまでダウンロード
4. 制限超過時のメッセージを確認
```

## よくある問題と対処法

### 1. E2Eテストが失敗する
**原因**: データベース接続エラー
```
対処法:
- Supabaseの認証情報を確認
- データベースの接続状態を確認
- 管理者権限を確認
```

### 2. テストサブスクリプションが作成されない
**原因**: 重複エラー
```
対処法:
- 既存のテストサブスクリプションを削除
- テスト環境を初期化
- ユーザーIDを確認
```

### 3. Stripe決済テストが失敗する
**原因**: APIキーの設定エラー
```
対処法:
- Stripe API キーを確認
- テストモードになっているか確認
- Webhookの設定を確認
```

## テストデータ管理

### 1. テスト環境初期化
```
「テスト環境初期化」ボタンをクリック
- すべてのテストサブスクリプションを削除
- テストユーザーを作成
- 初期状態にリセット
```

### 2. テストデータ確認
```
「テストサブスクリプション一覧」セクションで確認
- ユーザーID（一部）
- プラン名
- 状態（active/inactive）
- 有効期限
- 作成日
```

## セキュリティ注意事項

### 1. 本番環境での使用禁止
- テスト機能は開発環境でのみ使用
- 本番環境では無効化する
- 管理者権限での実行のみ

### 2. テストデータの管理
- テストデータは定期的に削除
- 実際のユーザーデータと分離
- Stripe本番キーは使用しない

## 参考資料

### 1. Stripe文書
- [Stripe Test Cards](https://stripe.com/docs/testing#cards)
- [Stripe Webhooks](https://stripe.com/docs/webhooks)

### 2. Supabase文書
- [Supabase Auth](https://supabase.com/docs/guides/auth)
- [Supabase Database](https://supabase.com/docs/guides/database)

### 3. 関連ファイル
- `/src/lib/subscriptionTest.ts` - テストロジック
- `/src/components/SubscriptionTestPanel.tsx` - テストUI
- `/src/lib/stripe.ts` - Stripe統合
- `/src/lib/supabase.ts` - Supabase設定

## 問題報告

テストに関する問題や改善提案は以下の項目を含めて報告してください：

1. **環境情報**: OS、ブラウザ、バージョン
2. **エラー内容**: エラーメッセージ、発生手順
3. **期待動作**: 期待される結果
4. **実際の動作**: 実際に発生した結果
5. **再現手順**: 問題を再現する手順

---

このガイドに従って、サブスクリプション機能の包括的なテストを実行できます。